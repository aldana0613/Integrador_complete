<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mis Capacitaciones | Panel del Empleado</title>
  <link rel="stylesheet" href="estilos.css">
</head>
<body>
  <div class="app-window">
    <div class="title-bar">
      <span>Panel del Empleado - Mis Capacitaciones</span>
      <div class="window-controls">
        <span class="control-btn" title="Minimizar">_</span>
        <span class="control-btn" title="Maximizar">‚òê</span>
        <span class="control-btn" title="Cerrar">X</span>
      </div>
    </div>

    <div class="app-container">
      <aside class="sidebar">
        <h2>Men√∫</h2>
        <nav>
          <a href="empleado_dashboard.html">üè† Inicio</a>
          <a href="registro.html">üìù Reportar Incidente</a>
          <a href="comentarios.html">üí¨ Enviar Comentario</a>
          <a href="capacitaciones_empleado.html" class="active">üìÖ Mis Capacitaciones</a>
          <a href="login.html" class="logout-btn">‚û°Ô∏è Cerrar Sesi√≥n</a>
        </nav>
      </aside>

      <main class="main-content">
        <h2>üìÖ Mis Capacitaciones Programadas</h2>

        <!-- Notificaciones -->
        <div class="notifications" style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
          <h3>üîî Mis Pr√≥ximas Capacitaciones</h3>
          <ul id="notificaciones-lista">
            <!-- Se llena din√°micamente -->
          </ul>
        </div>

        <!-- Lista de Capacitaciones -->
        <section class="tabla-capacitaciones">
          <h3>üìã Todas mis Capacitaciones</h3>
          <table>
            <thead>
              <tr>
                <th>Tema</th>
                <th>Fecha</th>
                <th>Hora</th>
                <th>Duraci√≥n</th>
                <th>Responsable</th>
                <th>√Årea</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="lista-capacitaciones">
              <!-- Se llena din√°micamente -->
            </tbody>
          </table>
        </section>

        <!-- Calendario Simplificado -->
        <section class="calendario-section">
          <h3>üóìÔ∏è Calendario de Capacitaciones</h3>
          <div id="calendar" style="background: #f8f9fa; padding: 20px; border-radius: 5px; min-height: 200px;">
            <!-- Calendario se carga aqu√≠ -->
          </div>
        </section>
      </main>
    </div>
  </div>

  <script>
// Funci√≥n para cargar capacitaciones del empleado
async function cargarCapacitacionesEmpleado() {
    try {
        console.log("üìÖ Cargando capacitaciones para empleado...");
        
        const response = await fetch('http://localhost:8081/api/capacitaciones');
        const capacitaciones = await response.json();
        
        console.log("‚úÖ Capacitaciones cargadas:", capacitaciones.length);
        actualizarNotificaciones(capacitaciones);
        actualizarListaCapacitaciones(capacitaciones);
        actualizarCalendarioEmpleado(capacitaciones);
        
    } catch (error) {
        console.error('‚ùå Error cargando capacitaciones:', error);
    }
}

// Actualizar notificaciones
function actualizarNotificaciones(capacitaciones) {
    const lista = document.getElementById('notificaciones-lista');
    lista.innerHTML = '';
    
    // Filtrar capacitaciones pr√≥ximas (pr√≥ximos 7 d√≠as)
    const hoy = new Date();
    const unaSemana = new Date(hoy.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    const capacitacionesProximas = capacitaciones.filter(cap => {
        const fechaCap = new Date(cap.fecha);
        return fechaCap >= hoy && fechaCap <= unaSemana;
    });
    
    if (capacitacionesProximas.length === 0) {
        lista.innerHTML = '<li>No hay capacitaciones programadas para la pr√≥xima semana</li>';
        return;
    }
    
    capacitacionesProximas.forEach(cap => {
        const fecha = new Date(cap.fecha).toLocaleDateString();
        const hora = cap.hora ? cap.hora.substring(0, 5) : '--:--';
        const li = document.createElement('li');
        li.innerHTML = `<strong>${fecha} ${hora}</strong> - ${cap.tema} (${cap.responsable})`;
        lista.appendChild(li);
    });
}

// Actualizar lista de capacitaciones
function actualizarListaCapacitaciones(capacitaciones) {
    const tabla = document.getElementById('lista-capacitaciones');
    tabla.innerHTML = '';
    
    if (capacitaciones.length === 0) {
        tabla.innerHTML = '<tr><td colspan="7">No hay capacitaciones programadas</td></tr>';
        return;
    }
    
    // Ordenar por fecha (m√°s pr√≥ximas primero)
    capacitaciones.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
    
    const hoy = new Date();
    
    capacitaciones.forEach(cap => {
        const fecha = new Date(cap.fecha);
        const fechaStr = fecha.toLocaleDateString();
        const hora = cap.hora ? cap.hora.substring(0, 5) : '--:--';
        const estado = fecha < hoy ? 'Completada' : 'Programada';
        const estadoClass = fecha < hoy ? 'atendido' : 'pendiente';
        
        const fila = `
            <tr>
                <td>${cap.tema}</td>
                <td>${fechaStr}</td>
                <td>${hora}</td>
                <td>${cap.duracion || '2'} horas</td>
                <td>${cap.responsable}</td>
                <td>${cap.area}</td>
                <td><span class="estado ${estadoClass}">${estado}</span></td>
            </tr>
        `;
        tabla.innerHTML += fila;
    });
}

// Actualizar calendario para empleado
function actualizarCalendarioEmpleado(capacitaciones) {
    const calendarEl = document.getElementById('calendar');
    calendarEl.innerHTML = '';
    
    if (capacitaciones.length === 0) {
        calendarEl.innerHTML = '<p>No hay capacitaciones programadas</p>';
        return;
    }
    
    // Crear elementos simples para el calendario
    capacitaciones.forEach(cap => {
        const fecha = new Date(cap.fecha);
        const fechaStr = fecha.toLocaleDateString();
        const hora = cap.hora ? cap.hora.substring(0, 5) : '';
        const esPasada = fecha < new Date();
        
        const eventoDiv = document.createElement('div');
        eventoDiv.className = 'calendario-evento';
        eventoDiv.innerHTML = `
            <strong>${fechaStr} ${hora}</strong><br>
            ${cap.tema}<br>
            <small>Por: ${cap.responsable}</small>
            <br><small>Estado: ${esPasada ? '‚úÖ Completada' : '‚è≥ Programada'}</small>
        `;
        eventoDiv.style.cssText = `
            background: ${esPasada ? '#e8f5e8' : '#e3f2fd'}; 
            border-left: 4px solid ${esPasada ? '#4caf50' : '#2196f3'}; 
            padding: 10px; 
            margin: 5px 0; 
            border-radius: 4px;
        `;
        calendarEl.appendChild(eventoDiv);
    });
}

// Inicializar cuando la p√°gina cargue
document.addEventListener('DOMContentLoaded', function() {
    console.log("üöÄ Inicializando capacitaciones empleado...");
    
    // Verificar que est√° logueado como empleado
    const usuario = sessionStorage.getItem('usuario');
    const rol = sessionStorage.getItem('rol');
    
    if (!usuario) {
        window.location.href = 'login.html';
        return;
    }
    
    if (rol === 'admin') {
        // Si es admin, redirigir a la versi√≥n admin
        window.location.href = 'capacitaciones.html';
        return;
    }
    
    cargarCapacitacionesEmpleado();
    
    // Actualizar cada 30 segundos
    setInterval(cargarCapacitacionesEmpleado, 30000);
});
  </script>
</body>
</html>