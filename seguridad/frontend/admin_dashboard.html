<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Administrador | Seguridad Industrial</title>
  <link rel="stylesheet" href="estilos.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fb;
      color: #333;
      margin: 0;
    }

    .app-window { display: flex; flex-direction: column; height: 100vh; }

    /* üîµ Barra superior */
    .title-bar {
      background: #0d6efd;
      color: white;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
    }

    .window-controls { display: flex; gap: 10px; }
    .window-controls span { cursor: pointer; font-size: 16px; }

    .logout-top {
      background: #dc3545;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: bold;
      transition: 0.3s;
    }
    .logout-top:hover { background: #b02a37; }

    .app-container { display: flex; flex: 1; }

    /* üìÅ Sidebar */
    .sidebar {
      width: 230px;
      background: white;
      color: #333;
      display: flex;
      flex-direction: column;
      padding: 15px;
      border-right: 1px solid #ddd;
    }

    .sidebar h2 {
      text-align: center;
      border-bottom: 1px solid #ccc;
      padding-bottom: 10px;
      color: #0d6efd;
    }

    .sidebar nav a {
      display: block;
      color: #333;
      text-decoration: none;
      padding: 10px;
      margin: 4px 0;
      border-radius: 5px;
      transition: 0.2s;
    }
    .sidebar nav a.active { background: #0d6efd; color: white; font-weight: bold; }
    .sidebar nav a:hover { background: #0b5ed7; color: white; }

    /* üìÑ Main */
    .main-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    /* KPIs */
    .kpi-grid { display: flex; gap: 20px; }
    .kpi-card {
      flex: 1;
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }
    .kpi-card.danger { border-top: 4px solid #dc3545; }
    .kpi-card.warning { border-top: 4px solid #ffc107; }
    .kpi-card.success { border-top: 4px solid #198754; }

    /* Tablas */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
      border-radius: 6px;
      overflow: hidden;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background: #e9ecef; }

    .search-input {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid #aaa;
      border-radius: 5px;
    }

    /* Export */
    .export-buttons button {
      margin: 5px;
      padding: 10px 15px;
      background-color: #198754;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .export-buttons button:hover { background-color: #157347; }

    /* Charts */
    canvas {
      background: white;
      border-radius: 6px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-top: 20px;
    }
    .chart-section { margin-top: 30px; }
  </style>
</head>

<body>

<div class="app-window">

  <!-- üîµ Barra superior -->
  <div class="title-bar">
    <div class="window-controls">
      <span title="Minimizar">_</span>
      <span title="Maximizar">‚òê</span>
      <span title="Cerrar">X</span>
    </div>
    <span>Sistema de Gesti√≥n de Seguridad Industrial (ADMINISTRADOR)</span>
    <a href="login.html" class="logout-top">Cerrar Sesi√≥n</a>
  </div>

  <div class="app-container">

    <!-- üìÅ Sidebar -->
    <aside class="sidebar">
      <h2>M√≥dulos</h2>
      <nav>
        <a href="#" class="menu-link active">üìä Dashboard / Inicio</a>
        <a href="incidentes.html" class="menu-link">üìù Incidentes</a>
        <a href="comentarios_admin.html" class="menu-link">üí¨ Gesti√≥n de Comentarios</a>
        <a href="capacitaciones.html" class="menu-link">üìò Capacitaciones</a>
        <a href="admin_usuarios.html" class="menu-link">üë• Usuarios</a>
      </nav>
    </aside>

    <!-- üìÑ CONTENIDO PRINCIPAL -->
    <main class="main-content">
      <h2>Dashboard / Inicio</h2>

      <!-- KPIs -->
      <section class="kpi-grid">
        <div class="kpi-card danger">
          <h3>Tasa de Frecuencia (LTIFR)</h3>
          <p id="ltifr">-</p>
        </div>
        <div class="kpi-card warning">
          <h3>Incidentes Reportados</h3>
          <p id="incidentes-count">-</p>
        </div>
        <div class="kpi-card success">
          <h3>Cumplimiento de Inspecciones</h3>
          <p id="inspecciones">-</p>
        </div>
      </section>

      <!-- TABLA INCIDENTES -->
      <section class="tabla-incidencias">
        <h3>Incidencias Recientes</h3>
        <input type="text" class="search-input" placeholder="Buscar..." onkeyup="filtrarTabla(this, 'tabla-incidentes')">
        <table id="tabla-incidentes">
          <thead>
            <tr><th>ID</th><th>Fecha</th><th>Tipo</th><th>Ubicaci√≥n</th><th>Estado</th></tr>
          </thead>
          <tbody><tr><td colspan="5">‚è≥ Cargando...</td></tr></tbody>
        </table>
      </section>

      <!-- TABLA COMENTARIOS -->
      <section class="tabla-incidencias">
        <h3>Comentarios Recientes</h3>
        <input type="text" class="search-input" placeholder="Buscar..." onkeyup="filtrarTabla(this, 'tabla-comentarios')">
        <table id="tabla-comentarios">
          <thead>
            <tr><th>Fecha</th><th>Empleado</th><th>Comentario</th><th>Estado</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- TABLA CAPACITACIONES -->
      <section class="tabla-incidencias">
        <h3>Capacitaciones Programadas</h3>
        <input type="text" class="search-input" placeholder="Buscar..." onkeyup="filtrarTabla(this, 'tabla-capacitaciones')">
        <table id="tabla-capacitaciones">
          <thead>
            <tr><th>Fecha</th><th>Tema</th><th>Instructor</th><th>Estado</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- üìä Gr√°ficos -->
      <section class="chart-section">
        <h3>üìä Gr√°ficos de Seguridad</h3>
        <canvas id="chartTipos" width="400" height="200"></canvas>
        <canvas id="chartEstados" width="400" height="200"></canvas>
      </section>

      <!-- üì§ Exportar -->
      <section class="exportar-section">
        <h3>üì§ Exportar Reportes</h3>
        <div class="export-buttons">
          <button onclick="exportarExcel('incidentes')">üìä Incidentes a Excel</button>
          <button onclick="exportarExcel('comentarios')">üí¨ Comentarios a Excel</button>
          <button onclick="exportarExcel('capacitaciones')">üìò Capacitaciones a Excel</button>
        </div>
      </section>

    </main>
  </div>
</div>

<!-- LIBRER√çAS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<!-- üöÄ L√ìGICA JS -->
<script>

const API_BASE = "http://localhost:8081/api";

document.addEventListener("DOMContentLoaded", () => {
  cargarIncidentes();
  cargarComentarios();
  cargarCapacitaciones();
});


// ============================================================
// üìå FUNCI√ìN GENERAR TABLA INCIDENTES
// ============================================================
async function cargarIncidentes() {
  const tbody = document.querySelector("#tabla-incidentes tbody");
  tbody.innerHTML = "<tr><td colspan='5'>‚è≥ Cargando incidencias...</td></tr>";

  try {
    const response = await fetch(`${API_BASE}/incidentes`);
    const incidentes = await response.json();

    tbody.innerHTML = "";

    if (incidentes.length === 0) {
      tbody.innerHTML = "<tr><td colspan='5'>No hay incidentes registrados</td></tr>";
      return;
    }

    incidentes.sort((a, b) => new Date(b.fechaHora) - new Date(a.fechaHora));

    incidentes.slice(0, 10).forEach(inc => {
      const fecha = new Date(inc.fechaHora).toLocaleDateString();

      tbody.innerHTML += `
        <tr>
          <td>${inc.id}</td>
          <td>${fecha}</td>
          <td>${inc.tipoIncidencia}</td>
          <td>${inc.ubicacion}</td>
          <td>${inc.estado}</td>
        </tr>`;
    });

    document.getElementById("incidentes-count").textContent = incidentes.length;

    generarGraficos(incidentes);

  } catch (error) {
    console.error("‚ùå Error al cargar incidentes:", error);
    tbody.innerHTML = "<tr><td colspan='5'>Error al cargar incidentes</td></tr>";
  }
}


// ============================================================
// üìå FUNCI√ìN CARGAR COMENTARIOS
// ============================================================
async function cargarComentarios() {
  try {
    const response = await fetch(`${API_BASE}/comentarios`);
    const data = await response.json();

    const tbody = document.querySelector("#tabla-comentarios tbody");
    tbody.innerHTML = "";

    data.forEach(c => {
      tbody.innerHTML += `
        <tr>
          <td>${c.fecha}</td>
          <td>${c.empleado}</td>
          <td>${c.comentario}</td>
          <td>${c.estado}</td>
        </tr>`;
    });

  } catch (err) {
    console.error("Error al cargar comentarios:", err);
  }
}


// ============================================================
// üìå FUNCI√ìN CARGAR CAPACITACIONES
// ============================================================
async function cargarCapacitaciones() {
  try {
    const response = await fetch(`${API_BASE}/capacitaciones`);
    const data = await response.json();

    const tbody = document.querySelector("#tabla-capacitaciones tbody");

    tbody.innerHTML = "";
    data.forEach(cap => {
      tbody.innerHTML += `
        <tr>
          <td>${cap.fecha}</td>
          <td>${cap.tema}</td>
          <td>${cap.responsable}</td>
          <td>${cap.estado ?? "Pendiente"}</td>
        </tr>`;
    });

  } catch (err) {
    console.error("Error al cargar capacitaciones:", err);
  }
}


// ============================================================
// üìä GR√ÅFICOS
// ============================================================
function generarGraficos(incidentes) {
  const tipos = {};
  const estados = {};

  incidentes.forEach(i => {
    tipos[i.tipoIncidencia] = (tipos[i.tipoIncidencia] || 0) + 1;
    estados[i.estado] = (estados[i.estado] || 0) + 1;
  });

  // Bar
  new Chart(document.getElementById('chartTipos'), {
    type: 'bar',
    data: {
      labels: Object.keys(tipos),
      datasets: [{
        label: 'Cantidad de Incidentes',
        data: Object.values(tipos),
        backgroundColor: '#0d6efd'
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  // Pie
  new Chart(document.getElementById('chartEstados'), {
    type: 'pie',
    data: {
      labels: Object.keys(estados),
      datasets: [{
        data: Object.values(estados),
        backgroundColor: ['#dc3545', '#0d6efd', '#198754', '#ffc107']
      }]
    }
  });
}


// ============================================================
// üîç Buscador din√°mico
// ============================================================
function filtrarTabla(input, tablaId) {
  const filter = input.value.toLowerCase();
  const rows = document.querySelectorAll(`#${tablaId} tbody tr`);

  rows.forEach(row => {
    const visible = [...row.children]
      .some(td => td.textContent.toLowerCase().includes(filter));

    row.style.display = visible ? "" : "none";
  });
}


// ============================================================
// üì§ EXPORTAR EXCEL
// ============================================================
function exportarExcel(tipo) {
  let tablaId = '';

  if (tipo === 'incidentes') tablaId = 'tabla-incidentes';
  else if (tipo === 'comentarios') tablaId = 'tabla-comentarios';
  else if (tipo === 'capacitaciones') tablaId = 'tabla-capacitaciones';

  const tabla = document.getElementById(tablaId);
  if (!tabla) return alert('No se encontr√≥ la tabla: ' + tipo);

  const wb = XLSX.utils.table_to_book(tabla, { sheet: tipo });
  XLSX.writeFile(wb, `${tipo}_${new Date().toISOString().split('T')[0]}.xlsx`);
}

</script>

</body>
</html>